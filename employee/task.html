<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Management</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .modal-bg {
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1000;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-6 lg:p-10">
    <header
      class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between z-10 sticky top-0"
    >
      <div class="flex items-center space-x-4">
        <div
          class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
        >
          <img src="../assets/logo.png" alt="Logo" class="rounded-full" />
        </div>
        <h1 id="header-title" class="text-xl font-bold text-gray-800">
          Dashboard
        </h1>
      </div>
      <div class="flex items-center space-x-4">
        <a
          href="dashboard.php"
          class="text-gray-600 hover:text-blue-600 transition-colors"
        >
          <i class="fas fa-bell text-lg"></i>
        </a>
        <a
          href="dashboard.php"
          class="text-gray-600 hover:text-blue-600 transition-colors"
        >
          <i class="fas fa-home text-lg"></i>
        </a>
        <img
          id="profileIcon"
          src="https://placehold.co/40x40/FF5733/FFFFFF?text=P"
          alt="Profile"
          class="w-10 h-10 rounded-full cursor-pointer"
        />
        <!-- Profile Modal -->
        <div
          id="profileModal"
          class="fixed inset-0 hidden items-center justify-center modal-bg z-50"
        >
          <div
            class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs mx-4 flex flex-col items-center"
          >
            <img
              src="https://placehold.co/80x80/FFD700/000000?text=W+P"
              alt="Profile"
              class="w-20 h-20 rounded-full mb-4"
            />
            <button
              id="logoutBtn"
              class="w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 mb-2"
            >
              Log out
            </button>
            <button
              id="closeProfileModal"
              class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="mt-8 lg:mt-12">
      <div class="bg-white rounded-xl shadow-md p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">My Tasks</h2>
          <div class="flex space-x-2">
            <button
              data-status="all"
              class="filter-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300 transition-colors"
            >
              All
            </button>
            <button
              data-status="pending"
              class="filter-btn bg-yellow-200 text-yellow-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-yellow-300 transition-colors"
            >
              Pending
            </button>
            <button
              data-status="in-progress"
              class="filter-btn bg-blue-200 text-blue-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-blue-300 transition-colors"
            >
              In Progress
            </button>
            <button
              data-status="completed"
              class="filter-btn bg-green-200 text-green-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-green-300 transition-colors"
            >
              Completed
            </button>
          </div>
        </div>
        <div id="tasks-container" class="space-y-6">
          <!-- Tasks will be populated here by JavaScript -->
        </div>
        <!-- Attachment Modal -->
        <div
          id="attachment-modal"
          class="fixed inset-0 modal-bg flex items-center justify-center hidden"
        >
          <div
            class="bg-white p-8 rounded-2xl shadow-2xl max-w-2xl mx-auto w-full"
          >
            <div class="flex justify-between items-center mb-4">
              <h3
                id="attachment-modal-title"
                class="text-2xl font-bold text-gray-800"
              >
                Attachment
              </h3>
              <button
                id="close-attachment-modal"
                class="text-gray-500 hover:text-gray-700 text-lg"
              >
                &times;
              </button>
            </div>
            <div class="space-y-4">
              <div>
                <label
                  for="ack-note"
                  class="block text-sm font-medium text-gray-700"
                  >Description</label
                >
                <textarea
                  id="ack-note"
                  rows="3"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Enter a short description to enable download"
                  required
                ></textarea>
                <p id="ack-error" class="text-red-600 text-sm mt-1 hidden">
                  Description is required.
                </p>
              </div>
              <div class="flex items-center gap-3">
                <a
                  id="attachment-download"
                  href="#"
                  target="_blank"
                  class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg cursor-not-allowed pointer-events-none"
                  title="Enter a description to enable download"
                  >Download</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Add Task Modal -->
    <div
      id="add-task-modal"
      class="fixed inset-0 modal-bg flex items-center justify-center hidden"
    >
      <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg mx-auto w-full">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold text-gray-800">Add New Task</h3>
          <button
            id="close-add-task-modal"
            class="text-gray-500 hover:text-gray-700 text-lg"
          >
            &times;
          </button>
        </div>
        <form id="add-task-form" class="space-y-4">
          <div>
            <label
              for="task-title"
              class="block text-sm font-medium text-gray-700"
              >Task Title</label
            >
            <input
              type="text"
              id="task-title"
              required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label
              for="task-description"
              class="block text-sm font-medium text-gray-700"
              >Description</label
            >
            <textarea
              id="task-description"
              rows="3"
              required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            ></textarea>
          </div>
          <div>
            <label
              for="task-due-date"
              class="block text-sm font-medium text-gray-700"
              >Due Date</label
            >
            <input
              type="date"
              id="task-due-date"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="flex justify-end space-x-4">
            <button
              type="button"
              id="cancel-add-task"
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
            >
              Add Task
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast-notification"
      class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl hidden transition-opacity duration-300 ease-in-out"
    >
      Task updated successfully!
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- MODAL & UI ELEMENTS ---
        const addTaskBtn = document.getElementById("add-task-btn");
        const addTaskModal = document.getElementById("add-task-modal");
        const closeAddTaskModalBtn = document.getElementById(
          "close-add-task-modal"
        );
        const cancelAddTaskBtn = document.getElementById("cancel-add-task");
        const addTaskForm = document.getElementById("add-task-form");
        const tasksContainer = document.getElementById("tasks-container");

        const filterBtns = document.querySelectorAll(".filter-btn");
        const toastNotification = document.getElementById("toast-notification");
        // Attachment modal refs
        const attachmentModal = document.getElementById("attachment-modal");
        const closeAttachmentModalBtn = document.getElementById(
          "close-attachment-modal"
        );
        const ackNoteInput = document.getElementById("ack-note");
        const ackError = document.getElementById("ack-error");
        const attachmentDownload = document.getElementById(
          "attachment-download"
        );
        // no submit button anymore

        let currentTaskToUpdateId = null;

        // --- DATA FROM API ---
        let tasks = []; // {id,title,description,due_date,status,attachment_path}

        function fmtDate(d) {
          if (!d) return "";
          try {
            return new Date(d).toISOString().slice(0, 10);
          } catch (e) {
            return d;
          }
        }

        async function fetchTasks(filterStatus) {
          try {
            const qs =
              filterStatus && filterStatus !== "all"
                ? "?status=" +
                  (filterStatus === "in-progress"
                    ? "in_progress"
                    : filterStatus)
                : "";
            const res = await fetch("../api/tasks_list_employee.php" + qs, {
              credentials: "include",
            });
            const data = await res.json();
            if (!data.success) {
              tasksContainer.innerHTML =
                '<p class="text-center text-red-600">Failed to load tasks.</p>';
              return;
            }
            tasks = data.tasks.map((t) => ({
              id: t.id,
              title: t.title,
              description: t.description || "",
              dueDate: fmtDate(t.due_date),
              status: (t.status || "pending").replace("_", "-"),
              attachment: t.attachment_path || null,
              submissionNote: t.submission_note || "",
              ackNote: t.ack_note || "",
              ackAt: t.ack_at || null,
            }));
            renderTasks(tasks);
          } catch (err) {
            tasksContainer.innerHTML =
              '<p class="text-center text-red-600">Network error loading tasks.</p>';
          }
        }

        // --- FUNCTIONALITY ---

        // Function to render tasks dynamically
        function renderTasks(filteredTasks) {
          tasksContainer.innerHTML = ""; // Clear existing tasks
          const tasksToRender = filteredTasks || tasks;

          if (tasksToRender.length === 0) {
            tasksContainer.innerHTML =
              '<p class="text-center text-gray-500">No tasks found for this status.</p>';
            return;
          }

          tasksToRender.forEach((task) => {
            const statusText = task.status.replace("-", " ");
            const statusColor =
              task.status === "pending"
                ? "bg-yellow-100 text-yellow-800"
                : task.status === "in-progress"
                ? "bg-blue-100 text-blue-800"
                : "bg-green-100 text-green-800";

            const taskElement = document.createElement("div");
            taskElement.classList.add(
              "bg-gray-50",
              "p-6",
              "rounded-xl",
              "shadow-sm",
              "border",
              "border-gray-200"
            );
            taskElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold ${statusColor} px-3 py-1 rounded-full capitalize">${statusText}</span>
                            <span class="text-xs text-gray-500">Due: ${
                              task.dueDate
                            }</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${
                          task.title
                        }</h3>
                        <p class="text-sm text-gray-600 mb-4">${
                          task.description
                        }</p>
                        ${
                          task.attachment
                            ? `<button data-id="${task.id}" class="open-attachment-btn text-sm text-white bg-gray-700 px-3 py-1 rounded hover:bg-gray-800 inline-flex items-center"><i class="fas fa-paperclip mr-2"></i>View attachment</button>`
                            : ""
                        }
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full ${
                              task.status === "completed"
                                ? "bg-green-600"
                                : task.status === "in-progress"
                                ? "bg-blue-600"
                                : "bg-yellow-600"
                            }" style="width: ${
              task.status === "completed"
                ? "100"
                : task.status === "in-progress"
                ? "60"
                : "20"
            }%"></div>
                        </div>
                        
                    `;
            tasksContainer.appendChild(taskElement);
          });
        }

        // Function to show a toast notification
        function showToast(message) {
          toastNotification.textContent = message;
          toastNotification.classList.remove("hidden");
          setTimeout(() => {
            toastNotification.classList.add("hidden");
          }, 3000); // Hide after 3 seconds
        }

        // --- EVENT LISTENERS ---

        // Event listener for the "Add Task" button
        if (addTaskBtn) {
          addTaskBtn.addEventListener("click", () => {
            addTaskModal.classList.remove("hidden");
          });
        }

        // Event listeners to close the Add Task modal
        if (closeAddTaskModalBtn && cancelAddTaskBtn) {
          closeAddTaskModalBtn.addEventListener("click", () => {
            addTaskModal.classList.add("hidden");
          });
          cancelAddTaskBtn.addEventListener("click", () => {
            addTaskModal.classList.add("hidden");
          });
        }

        // Event listener for the Add Task form submission
        // Employee's Add Task form was previously local-only; disable or repurpose as needed.
        if (addTaskForm) {
          addTaskForm.addEventListener("submit", (e) => {
            e.preventDefault();
            // Optional: allow employees to add personal tasks — not persisted for now
            addTaskModal.classList.add("hidden");
            addTaskForm.reset();
            showToast(
              "This form is disabled. Tasks are assigned by your department head."
            );
          });
        }

        // Event listener for View attachment buttons
        if (tasksContainer) {
          tasksContainer.addEventListener("click", (e) => {
            if (e.target.classList.contains("open-attachment-btn")) {
              const btn = e.target;
              currentTaskToUpdateId = parseInt(btn.dataset.id);
              // Reset UI
              ackNoteInput.value = "";
              ackError.classList.add("hidden");
              const tsk = tasks.find((t) => t.id === currentTaskToUpdateId);
              // Prefill note if exists (from submission_note)
              ackNoteInput.value =
                tsk && tsk.submissionNote ? tsk.submissionNote : "";
              // Update modal title with task name
              const modalTitle = document.getElementById(
                "attachment-modal-title"
              );
              if (modalTitle && tsk) {
                modalTitle.textContent = `Attachment for ${tsk.title}`;
              }
              // Disable download until non-empty
              updateDownloadState();
              attachmentModal.classList.remove("hidden");
              // Autofocus textarea for quick typing
              setTimeout(() => ackNoteInput && ackNoteInput.focus(), 0);
            }
          });
        }
        // Attachment modal controls
        if (closeAttachmentModalBtn)
          closeAttachmentModalBtn.addEventListener("click", () =>
            attachmentModal.classList.add("hidden")
          );
        // Enable/disable Download based on description content; on click, save then download and close
        const updateDownloadState = () => {
          if (!ackNoteInput || !attachmentDownload) return;
          const hasText = (ackNoteInput.value || "").trim().length > 0;
          if (hasText) {
            attachmentDownload.classList.remove(
              "cursor-not-allowed",
              "pointer-events-none",
              "bg-gray-300",
              "text-gray-600"
            );
            attachmentDownload.classList.add("bg-blue-600", "text-white");
            attachmentDownload.setAttribute("title", "Download attachment");
          } else {
            attachmentDownload.classList.add(
              "cursor-not-allowed",
              "pointer-events-none",
              "bg-gray-300",
              "text-gray-600"
            );
            attachmentDownload.classList.remove("bg-blue-600", "text-white");
            attachmentDownload.setAttribute(
              "title",
              "Enter a description to enable download"
            );
          }
        };
        if (ackNoteInput) {
          ackNoteInput.addEventListener("input", () => {
            ackError.classList.add("hidden");
            updateDownloadState();
          });
        }
        if (attachmentDownload) {
          attachmentDownload.addEventListener("click", (e) => {
            const note = (ackNoteInput.value || "").trim();
            if (!note) {
              e.preventDefault();
              ackError.classList.remove("hidden");
              return;
            }
            e.preventDefault();
            // Save note and set in_progress, then trigger download and close modal
            const fd = new FormData();
            fd.append("id", String(currentTaskToUpdateId));
            fd.append("note", note);
            fetch("../api/tasks_acknowledge.php", {
              method: "POST",
              body: fd,
              credentials: "include",
            })
              .then((r) => r.json())
              .then((data) => {
                if (!data.success) throw new Error(data.error || "Save failed");
                // Optimistically update local state
                const idx = tasks.findIndex(
                  (t) => t.id === currentTaskToUpdateId
                );
                if (idx !== -1) {
                  tasks[idx].submissionNote = note;
                  tasks[idx].status = "in-progress";
                }
                renderTasks();
                // Trigger download
                const url = `../api/tasks_download_attachment.php?id=${currentTaskToUpdateId}`;
                window.open(url, "_blank");
                // Close modal
                attachmentModal.classList.add("hidden");
              })
              .catch((err) => {
                showToast(err.message || "Failed to save description.");
              });
          });
        }

        // Close attachment modal by clicking outside content
        if (attachmentModal) {
          attachmentModal.addEventListener("click", (e) => {
            if (e.target === attachmentModal) {
              attachmentModal.classList.add("hidden");
            }
          });
          // Close on ESC
          document.addEventListener("keydown", (e) => {
            if (
              e.key === "Escape" &&
              !attachmentModal.classList.contains("hidden")
            ) {
              attachmentModal.classList.add("hidden");
            }
          });
        }

        // Event listener for filter buttons (maps in-progress <-> in_progress)
        if (filterBtns) {
          filterBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const statusFilter = e.target.dataset.status; // 'all' | 'pending' | 'in-progress' | 'completed'
              fetchTasks(statusFilter);
            });
          });
        }

        // Initial load
        fetchTasks("all");
      });
    </script>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Profile Modal logic
      const profileIcon = document.getElementById("profileIcon");
      const profileModal = document.getElementById("profileModal");
      const logoutBtn = document.getElementById("logoutBtn");
      const closeProfileModal = document.getElementById("closeProfileModal");
      profileIcon.addEventListener("click", () => {
        profileModal.classList.remove("hidden");
        profileModal.classList.add("flex");
      });
      closeProfileModal.addEventListener("click", () => {
        profileModal.classList.add("hidden");
        profileModal.classList.remove("flex");
      });
      logoutBtn.addEventListener("click", () => {
        window.location.href = "logout.php";
      });
      profileModal.addEventListener("click", (e) => {
        if (e.target === profileModal) {
          profileModal.classList.add("hidden");
          profileModal.classList.remove("flex");
        }
      });
    });
  </script>
</html>
