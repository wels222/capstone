<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Management</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .modal-bg {
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1000;
      }
      /* Filter button active state */
      .filter-btn.active {
        transform: translateY(-3px);
        box-shadow: 0 6px 18px rgba(16, 24, 40, 0.08);
        outline: 2px solid rgba(0,0,0,0.04);
      }
    </style>
  </head>
  <body class="bg-gray-100 p-6 lg:p-10">
    <header
      class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between z-10 sticky top-0"
    >
      <div class="flex items-center space-x-4">
        <div
          class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
        >
          <img src="../assets/logo.png" alt="Logo" class="rounded-full" />
        </div>
        <h1 id="header-title" class="text-xl font-bold text-gray-800">
          Dashboard
        </h1>
      </div>
      <div class="flex items-center space-x-4">
        <a
          href="dashboard.php"
          class="text-gray-600 hover:text-blue-600 transition-colors"
        >
          <i class="fas fa-bell text-lg"></i>
        </a>
        <a
          href="dashboard.php"
          class="text-gray-600 hover:text-blue-600 transition-colors"
        >
          <i class="fas fa-home text-lg"></i>
        </a>
        <img
          id="profileIcon"
          src="https://placehold.co/40x40/FF5733/FFFFFF?text=P"
          alt="Profile"
          class="w-10 h-10 rounded-full cursor-pointer"
        />
        <!-- Profile Modal -->
        <div
          id="profileModal"
          class="fixed inset-0 hidden items-center justify-center modal-bg z-50"
        >
          <div
            class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs mx-4 flex flex-col items-center"
          >
            <img
              src="https://placehold.co/80x80/FFD700/000000?text=W+P"
              alt="Profile"
              class="w-20 h-20 rounded-full mb-4"
            />
            <button
              id="logoutBtn"
              class="w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 mb-2"
            >
              Log out
            </button>
            <button
              id="closeProfileModal"
              class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="mt-8 lg:mt-12">
      <div class="bg-white rounded-xl shadow-md p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">My Tasks</h2>
          <div class="flex space-x-2">
            <button
              data-status="all"
              class="filter-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300 transition-colors"
            >
              All
            </button>
            <button
              data-status="pending"
              class="filter-btn bg-yellow-200 text-yellow-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-yellow-300 transition-colors"
            >
              Pending
            </button>
            <button
              data-status="in-progress"
              class="filter-btn bg-blue-200 text-blue-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-blue-300 transition-colors"
            >
              In Progress
            </button>
            <button
              data-status="missed"
              class="filter-btn bg-red-200 text-red-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-red-300 transition-colors"
            >
              Missed
            </button>
            <button
              data-status="completed"
              class="filter-btn bg-green-200 text-green-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-green-300 transition-colors"
            >
              Completed
            </button>
          </div>
        </div>
        <div id="tasks-container" class="space-y-6">
          <!-- Tasks will be populated here by JavaScript -->
        </div>
        <!-- Attachment Modal -->
        <div
          id="attachment-modal"
          class="fixed inset-0 modal-bg flex items-center justify-center hidden"
        >
          <div
            class="bg-white p-8 rounded-2xl shadow-2xl max-w-2xl mx-auto w-full"
          >
            <div class="flex justify-between items-center mb-4">
              <h3
                id="attachment-modal-title"
                class="text-2xl font-bold text-gray-800"
              >
                Attachment
              </h3>
              <button
                id="close-attachment-modal"
                class="text-gray-500 hover:text-gray-700 text-lg"
              >
                &times;
              </button>
            </div>
            <div class="space-y-4">
              <div>
                <label
                  for="ack-note"
                  class="block text-sm font-medium text-gray-700"
                  >Description</label
                >
                <textarea
                  id="ack-note"
                  rows="3"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Enter a short description to enable download"
                  required
                ></textarea>
                <p id="ack-error" class="text-red-600 text-sm mt-1 hidden">
                  Description is required.
                </p>
              </div>
              <div class="flex items-center gap-3">
                <a
                  id="attachment-download"
                  href="#"
                  target="_blank"
                  class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg cursor-not-allowed pointer-events-none"
                  title="Enter a description to enable download"
                  >Download</a
                >
              </div>
            </div>
        </div>
      </div>
    </main>

    <!-- Add Task Modal -->
    <!-- Submit Modal (moved here so it's not nested inside the Attachment modal) -->
    <div
      id="submit-modal"
      class="fixed inset-0 modal-bg flex items-center justify-center hidden"
    >
      <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-2xl mx-auto w-full">
        <div class="flex justify-between items-center mb-4">
          <h3 id="submit-modal-title" class="text-2xl font-bold text-gray-800">Submit Task</h3>
          <button id="close-submit-modal" class="text-gray-500 hover:text-gray-700 text-lg">&times;</button>
        </div>
        <form id="submit-form" class="space-y-4" enctype="multipart/form-data">
          <input type="hidden" id="submit-task-id" name="id" />
          <input type="hidden" id="submit-mode-input" name="mode" value="submit" />
          <div id="submit-mode-label" class="text-sm text-gray-500 mb-2 hidden">Append mode: file not required</div>
          <div>
            <label for="submit-note" class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="submit-note" name="note" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter a short description" required></textarea>
          </div>
          <div id="submit-file-wrapper">
            <label for="submit-file" class="block text-sm font-medium text-gray-700">Upload file</label>
            <input id="submit-file" name="file" type="file" class="mt-1 block w-full" />
          </div>
          <div class="flex justify-end space-x-4">
            <button type="button" id="cancel-submit" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors">Submit</button>
          </div>
        </form>
      </div>
    </div>
      <!-- Pending notice modal: shown when user attempts to submit while task is still pending -->
      <div id="pending-modal" class="fixed inset-0 modal-bg flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Cannot Submit Yet</h3>
            <button id="close-pending-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <p class="text-sm text-gray-700 mb-4">This task is still pending. You must acknowledge or mark it as in-progress before you can submit a final file.</p>
          <div class="flex justify-end">
            <button id="pending-ok" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
          </div>
        </div>
      </div>
    <div
      id="add-task-modal"
      class="fixed inset-0 modal-bg flex items-center justify-center hidden"
    >
      <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg mx-auto w-full">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold text-gray-800">Add New Task</h3>
          <button
            id="close-add-task-modal"
            class="text-gray-500 hover:text-gray-700 text-lg"
          >
            &times;
          </button>
        </div>
        <form id="add-task-form" class="space-y-4">
          <div>
            <label
              for="task-title"
              class="block text-sm font-medium text-gray-700"
              >Task Title</label
            >
            <input
              type="text"
              id="task-title"
              required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label
              for="task-description"
              class="block text-sm font-medium text-gray-700"
              >Description</label
            >
            <textarea
              id="task-description"
              rows="3"
              required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            ></textarea>
          </div>
          <div>
            <label
              for="task-due-date"
              class="block text-sm font-medium text-gray-700"
              >Due Date</label
            >
            <input
              type="date"
              id="task-due-date"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="flex justify-end space-x-4">
            <button
              type="button"
              id="cancel-add-task"
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
            >
              Add Task
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast-notification"
      class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl hidden transition-opacity duration-300 ease-in-out"
    >
      Task updated successfully!
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- MODAL & UI ELEMENTS ---
        const addTaskBtn = document.getElementById("add-task-btn");
        const addTaskModal = document.getElementById("add-task-modal");
        const closeAddTaskModalBtn = document.getElementById(
          "close-add-task-modal"
        );
        const cancelAddTaskBtn = document.getElementById("cancel-add-task");
        const addTaskForm = document.getElementById("add-task-form");
        const tasksContainer = document.getElementById("tasks-container");

        const filterBtns = document.querySelectorAll(".filter-btn");
        const toastNotification = document.getElementById("toast-notification");
        // Attachment modal refs
        const attachmentModal = document.getElementById("attachment-modal");
        const closeAttachmentModalBtn = document.getElementById(
          "close-attachment-modal"
        );
        const ackNoteInput = document.getElementById("ack-note");
        const ackError = document.getElementById("ack-error");
        const attachmentDownload = document.getElementById(
          "attachment-download"
        );
        // Submit modal refs
        const submitModal = document.getElementById("submit-modal");
        const closeSubmitModalBtn = document.getElementById("close-submit-modal");
        const submitForm = document.getElementById("submit-form");
        const submitTaskIdInput = document.getElementById("submit-task-id");
        const submitNoteInput = document.getElementById("submit-note");
        const submitFileInput = document.getElementById("submit-file");
        const cancelSubmitBtn = document.getElementById("cancel-submit");
        // no submit button anymore

  let currentTaskToUpdateId = null;
  // submit mode is stored per-form in #submit-mode-input to keep append and submit independent

        // --- DATA FROM API ---
        let tasks = []; // {id,title,description,due_date,status,attachment_path}

        function fmtDate(d) {
          if (!d) return "";
          try {
            return new Date(d).toISOString().slice(0, 10);
          } catch (e) {
            return d;
          }
        }
        function fmtDateTime(d) {
          if (!d) return "";
          try {
            const dt = parseLocalDateTime(d);
            if (!dt) return d;
            return dt.toLocaleString(undefined, {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: true
            });
          } catch (e) {
            return d;
          }
        }
        function timeAgo(d) {
          if (!d) return "";
          try {
            const now = new Date();
            const t = parseLocalDateTime(d);
            const diff = Math.floor((t - now) / 1000);
            const abs = Math.abs(diff);
            if (abs < 60) return diff >= 0 ? `in ${abs}s` : `${abs}s ago`;
            if (abs < 3600) return diff >= 0 ? `in ${Math.floor(abs/60)}m` : `${Math.floor(abs/60)}m ago`;
            if (abs < 86400) return diff >= 0 ? `in ${Math.floor(abs/3600)}h` : `${Math.floor(abs/3600)}h ago`;
            return diff >= 0 ? `in ${Math.floor(abs/86400)}d` : `${Math.floor(abs/86400)}d ago`;
          } catch(e){ return ""; }
        }

        // Parse backend datetime string like "YYYY-MM-DD HH:MM[:SS]" or with 'T' into a local Date
        function parseLocalDateTime(s) {
          if (!s) return null;
          const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/);
          if (m) {
            const y = parseInt(m[1], 10);
            const mo = parseInt(m[2], 10) - 1;
            const day = parseInt(m[3], 10);
            const hh = parseInt(m[4], 10);
            const mm = parseInt(m[5], 10);
            const ss = m[6] ? parseInt(m[6], 10) : 0;
            return new Date(y, mo, day, hh, mm, ss);
          }
          const fallback = new Date(s);
          return isNaN(fallback.getTime()) ? null : fallback;
        }

        async function fetchTasks(filterStatus) {
          try {
            let qs = "";
            // 'missed' is a client-side derived filter — fetch all and filter locally
            if (filterStatus && filterStatus !== "all" && filterStatus !== "missed") {
              qs = "?status=" + (filterStatus === "in-progress" ? "in_progress" : filterStatus);
            }
            const res = await fetch("../api/tasks_list_employee.php" + qs, {
              credentials: "include",
            });
            const data = await res.json();
            if (!data.success) {
              tasksContainer.innerHTML =
                '<p class="text-center text-red-600">Failed to load tasks.</p>';
              return;
            }
            tasks = data.tasks.map((t) => {
              const dueRaw = t.due_date;
              let isMissed = false;
              try {
                    if (dueRaw && parseLocalDateTime(dueRaw) && parseLocalDateTime(dueRaw) < new Date() && (t.status !== 'completed')) {
                  isMissed = true;
                }
              } catch (e) { /* ignore parse errors */ }
              return {
                id: t.id,
                title: t.title,
                description: t.description || "",
                dueRaw: dueRaw,
                dueDate: fmtDate(dueRaw),
                status: (t.status || "pending").replace("_", "-"),
                isMissed: isMissed,
                attachment: t.attachment_path || null,
                submissionFile: t.submission_file_path || null,
                submissionNote: t.submission_note || "",
                ackNote: t.ack_note || "",
                ackAt: t.ack_at || null,
              };
            });
            // Apply client-side filtering so overdue tasks (isMissed) are shown only in 'missed'
            if (filterStatus === "missed") {
              renderTasks(tasks.filter((t) => t.isMissed));
            } else if (filterStatus === "in-progress") {
              // Only include in-progress tasks that are NOT missed
              renderTasks(tasks.filter((t) => (t.status === 'in-progress') && !t.isMissed));
            } else if (filterStatus === "pending") {
              // Only include pending tasks that are NOT missed
              renderTasks(tasks.filter((t) => (t.status === 'pending') && !t.isMissed));
            } else if (filterStatus === "completed") {
              renderTasks(tasks.filter((t) => (t.status === 'completed')));
            } else {
              // all: show everything (including missed)
              renderTasks(tasks);
            }
          } catch (err) {
            tasksContainer.innerHTML =
              '<p class="text-center text-red-600">Network error loading tasks.</p>';
          }
        }

        // --- FUNCTIONALITY ---

        // Function to render tasks dynamically
        function renderTasks(filteredTasks) {
          tasksContainer.innerHTML = ""; // Clear existing tasks
          const tasksToRender = filteredTasks || tasks;

          if (tasksToRender.length === 0) {
            tasksContainer.innerHTML =
              '<p class="text-center text-gray-500">No tasks found for this status.</p>';
            return;
          }

          tasksToRender.forEach((task) => {
            // Determine if task is overdue (missed). If so, show missed regardless of status (except completed)
            let displayStatus = task.status.replace("-", " ");
            let statusColor = "bg-green-100 text-green-800"; // default for completed
            if (task.isMissed) {
              displayStatus = "missed";
              statusColor = "bg-red-100 text-red-800";
            } else if (task.status === "pending") {
              displayStatus = "pending";
              statusColor = "bg-yellow-100 text-yellow-800";
            } else if (task.status === "in-progress") {
              displayStatus = "in progress";
              statusColor = "bg-blue-100 text-blue-800";
            } else if (task.status === "completed") {
              displayStatus = "completed";
              statusColor = "bg-green-100 text-green-800";
            }

            const taskElement = document.createElement("div");
            taskElement.classList.add(
              "bg-gray-50",
              "p-6",
              "rounded-xl",
              "shadow-sm",
              "border",
              "border-gray-200"
            );
      taskElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
              <span class="text-sm font-semibold ${statusColor} px-3 py-1 rounded-full capitalize">${displayStatus}</span>
                            <div class="flex items-center space-x-2">
                              <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14v-4"></path></svg>
                              <div class="text-xs text-gray-500">${fmtDateTime(task.dueRaw)}</div>
                              <div class="text-xs text-gray-400">· ${timeAgo(task.dueRaw)}</div>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${
                          task.title
                        }</h3>
                        <p class="text-sm text-gray-600 mb-2">${
                          task.description
                        }</p>
                        ${task.submissionNote ? `<p class="text-sm italic text-gray-500 mb-2"><strong>Submission note:</strong> ${task.submissionNote}</p>` : ''}
                        <div class="flex items-center gap-2 mb-3">
                          ${
                            task.attachment
                              ? `<button data-id="${task.id}" class="open-attachment-btn text-sm text-white bg-gray-700 px-3 py-1 rounded hover:bg-gray-800 inline-flex items-center"><i class="fas fa-paperclip mr-2"></i>View attachment</button>`
                              : ""
                          }
                          ${task.submissionFile ? `<a href="../${task.submissionFile}" target="_blank" class="text-sm text-white bg-green-600 px-3 py-1 rounded hover:bg-green-700 inline-flex items-center"><i class="fas fa-file-alt mr-2"></i>View submission</a>` : ''}
                        </div>
                        <div class="flex items-center justify-between">
                          <div>
                                            ${task.status !== 'completed' ? `
                                              <div class="inline-flex items-center gap-2">
                                                <button data-id="${task.id}" class="open-submit-btn text-sm text-white bg-green-600 px-3 py-1 rounded hover:bg-green-700 inline-flex items-center"><i class="fas fa-upload mr-2"></i>Submit</button>
                                                ${task.isMissed ? `<button data-id="${task.id}" class="open-append-btn text-sm text-white bg-red-600 px-3 py-1 rounded hover:bg-red-700 inline-flex items-center"><i class="fas fa-plus mr-2"></i>Append</button>` : ''}
                                              </div>
                                            ` : `<span class="text-sm text-gray-500">Completed</span>`}
                          </div>
                          <div class="w-full ml-4">
                              <div class="w-full bg-gray-200 rounded-full h-2.5">
                              <div class="h-2.5 rounded-full ${
                                displayStatus === "completed"
                                  ? "bg-green-600"
                                  : displayStatus === "in progress"
                                  ? "bg-blue-600"
                                  : displayStatus === "missed"
                                  ? "bg-red-600"
                                  : "bg-yellow-600"
                              }" style="width: ${
                displayStatus === "completed"
                  ? "100"
                  : displayStatus === "in progress"
                  ? "60"
            : displayStatus === "missed"
              ? "100"
                  : "20"
              }%"></div>
                            </div>
                          </div>
                        </div>
                    `;
            tasksContainer.appendChild(taskElement);
          });
        }

        // Function to show a toast notification
        function showToast(message) {
          toastNotification.textContent = message;
          toastNotification.classList.remove("hidden");
          setTimeout(() => {
            toastNotification.classList.add("hidden");
          }, 3000); // Hide after 3 seconds
        }

        // --- EVENT LISTENERS ---

        // Event listener for the "Add Task" button
        if (addTaskBtn) {
          addTaskBtn.addEventListener("click", () => {
            addTaskModal.classList.remove("hidden");
          });
        }

        // Event listeners to close the Add Task modal
        if (closeAddTaskModalBtn && cancelAddTaskBtn) {
          closeAddTaskModalBtn.addEventListener("click", () => {
            addTaskModal.classList.add("hidden");
          });
          cancelAddTaskBtn.addEventListener("click", () => {
            addTaskModal.classList.add("hidden");
          });
        }

        // Event listener for the Add Task form submission
        // Employee's Add Task form was previously local-only; disable or repurpose as needed.
        if (tasksContainer) {
          tasksContainer.addEventListener("click", (e) => {
            // Use closest() so clicks on inner icons or children still resolve to the button element
            const attachBtn = e.target.closest && e.target.closest('.open-attachment-btn');
            const submitBtn = e.target.closest && e.target.closest('.open-submit-btn');

            if (attachBtn) {
              const btn = attachBtn;
              currentTaskToUpdateId = parseInt(btn.dataset.id);
              // Reset UI
              ackNoteInput.value = "";
              ackError.classList.add("hidden");
              const tsk = tasks.find((t) => t.id === currentTaskToUpdateId);
              // Prefill note if exists (from submission_note)
              ackNoteInput.value =
                tsk && tsk.submissionNote ? tsk.submissionNote : "";
              // Update modal title with task name
              const modalTitle = document.getElementById(
                "attachment-modal-title"
              );
              if (modalTitle && tsk) {
                modalTitle.textContent = `Attachment for ${tsk.title}`;
              }
              // Disable download until non-empty
              updateDownloadState();
              attachmentModal.classList.remove("hidden");
              // Autofocus textarea for quick typing
              setTimeout(() => ackNoteInput && ackNoteInput.focus(), 0);
              return; // stop to ensure only attachment logic runs
            }

            const appendBtn = e.target.closest && e.target.closest('.open-append-btn');
            if (appendBtn) {
              const btn = appendBtn;
              const id = parseInt(btn.dataset.id);
              currentTaskToUpdateId = id;
              const tsk = tasks.find((t) => t.id === id);
              // Open submit modal in append (iaDJUST) mode: file optional
              submitTaskIdInput.value = String(id);
              submitNoteInput.value = '';
              submitFileInput.value = '';
              const modalTitle = document.getElementById('submit-modal-title');
              if (modalTitle && tsk) modalTitle.textContent = `Request adjustment — ${tsk.title}`;
              // Update submit button label
              const submitBtnEl = submitForm.querySelector('button[type=submit]');
              if (submitBtnEl) submitBtnEl.textContent = 'Send Append';
              showSubmitModal('append');
              setTimeout(() => submitNoteInput && submitNoteInput.focus(), 0);
              return;
            }

            if (submitBtn) {
              const btn = submitBtn;
              const id = parseInt(btn.dataset.id);
              currentTaskToUpdateId = id;
              const tsk = tasks.find((t) => t.id === id);
              // Only allow final submission when the task is in-progress
              if (tsk && tsk.status !== 'in-progress') {
                const pendingModal = document.getElementById('pending-modal');
                if (pendingModal) pendingModal.classList.remove('hidden');
                return;
              }
              // Normal final submission mode: require file
              submitTaskIdInput.value = String(id);
              submitNoteInput.value = '';
              submitFileInput.value = '';
              const modalTitle = document.getElementById('submit-modal-title');
              if (modalTitle && tsk) modalTitle.textContent = `Submit ${tsk.title}`;
              // Update submit button label
              const submitBtnEl2 = submitForm.querySelector('button[type=submit]');
              if (submitBtnEl2) submitBtnEl2.textContent = 'Submit';
              showSubmitModal('submit');
              setTimeout(() => submitNoteInput && submitNoteInput.focus(), 0);
              return;
            }
          });
        }
        // Attachment modal controls
        if (closeAttachmentModalBtn)
          closeAttachmentModalBtn.addEventListener("click", () =>
            attachmentModal.classList.add("hidden")
          );
        // Enable/disable Download based on description content; on click, save then download and close
        const updateDownloadState = () => {
          if (!ackNoteInput || !attachmentDownload) return;
          const hasText = (ackNoteInput.value || "").trim().length > 0;
          if (hasText) {
            attachmentDownload.classList.remove(
              "cursor-not-allowed",
              "pointer-events-none",
              "bg-gray-300",
              "text-gray-600"
            );
            attachmentDownload.classList.add("bg-blue-600", "text-white");
            attachmentDownload.setAttribute("title", "Download attachment");
          } else {
            attachmentDownload.classList.add(
              "cursor-not-allowed",
              "pointer-events-none",
              "bg-gray-300",
              "text-gray-600"
            );
            attachmentDownload.classList.remove("bg-blue-600", "text-white");
            attachmentDownload.setAttribute(
              "title",
              "Enter a description to enable download"
            );
          }
        };
        if (ackNoteInput) {
          ackNoteInput.addEventListener("input", () => {
            ackError.classList.add("hidden");
            updateDownloadState();
          });
        }
        if (attachmentDownload) {
          attachmentDownload.addEventListener("click", (e) => {
            const note = (ackNoteInput.value || "").trim();
            if (!note) {
              e.preventDefault();
              ackError.classList.remove("hidden");
              return;
            }
            e.preventDefault();
            // Save note and set in_progress, then trigger download and close modal
            const fd = new FormData();
            fd.append("id", String(currentTaskToUpdateId));
            fd.append("note", note);
            fetch("../api/tasks_acknowledge.php", {
              method: "POST",
              body: fd,
              credentials: "include",
            })
              .then((r) => r.json())
              .then((data) => {
                if (!data.success) throw new Error(data.error || "Save failed");
                // Optimistically update local state
                const idx = tasks.findIndex(
                  (t) => t.id === currentTaskToUpdateId
                );
                if (idx !== -1) {
                  tasks[idx].submissionNote = note;
                  tasks[idx].status = "in-progress";
                }
                renderTasks();
                // Trigger download
                const url = `../api/tasks_download_attachment.php?id=${currentTaskToUpdateId}`;
                window.open(url, "_blank");
                // Close modal
                attachmentModal.classList.add("hidden");
              })
              .catch((err) => {
                showToast(err.message || "Failed to save description.");
              });
          });
        }

        // Close attachment modal by clicking outside content
        if (attachmentModal) {
          attachmentModal.addEventListener("click", (e) => {
            if (e.target === attachmentModal) {
              attachmentModal.classList.add("hidden");
            }
          });
          // Close on ESC
          document.addEventListener("keydown", (e) => {
            if (
              e.key === "Escape" &&
              !attachmentModal.classList.contains("hidden")
            ) {
              attachmentModal.classList.add("hidden");
            }
          });
        }

        // Submit modal controls
        function closeSubmitModal() {
          // Hide the submit modal and reset state
          if (submitModal) {
            submitModal.classList.add('hidden');
            submitModal.style.display = 'none';
          }
          // Reset form and input mode
          if (submitForm) submitForm.reset();
          const submitModeInput = document.getElementById('submit-mode-input');
          if (submitModeInput) submitModeInput.value = 'submit';
          if (submitFileWrapper) submitFileWrapper.style.display = '';
          if (submitFileInput) submitFileInput.required = true;
          // Also ensure other modals are closed to avoid overlapping containers
          if (attachmentModal) attachmentModal.classList.add('hidden');
          if (pendingModal) pendingModal.classList.add('hidden');
        }
        if (closeSubmitModalBtn) closeSubmitModalBtn.addEventListener('click', () => closeSubmitModal());
        if (cancelSubmitBtn) cancelSubmitBtn.addEventListener('click', (e) => { e.stopPropagation(); closeSubmitModal(); });
        const submitFileWrapper = document.getElementById('submit-file-wrapper');
        function showSubmitModal(mode) {
          const m = mode || 'submit';
          // set the hidden input so submit handler reads the mode from the form (keeps flows independent)
          const submitModeInput = document.getElementById('submit-mode-input');
          if (submitModeInput) submitModeInput.value = m;
          const submitModeLabel = document.getElementById('submit-mode-label');
          if (m === 'append') {
            // hide file chooser and make file optional
            if (submitFileWrapper) submitFileWrapper.style.display = 'none';
            if (submitFileInput) submitFileInput.required = false;
            if (submitModeLabel) submitModeLabel.classList.remove('hidden');
          } else {
            if (submitFileWrapper) submitFileWrapper.style.display = '';
            if (submitFileInput) submitFileInput.required = true;
            if (submitModeLabel) submitModeLabel.classList.add('hidden');
          }
          if (submitModal) {
            submitModal.classList.remove('hidden');
            // make sure overlay is visible
            submitModal.style.display = 'flex';
          }
        }

        if (submitModal) {
          submitModal.addEventListener('click', (e) => {
            if (e.target === submitModal) {
              closeSubmitModal();
            }
          });
        }

        // Update close button handlers to also reset state
        if (closeSubmitModalBtn) closeSubmitModalBtn.addEventListener('click', () => {
          submitModal.classList.add('hidden');
          submitMode = 'submit';
          if (submitFileWrapper) submitFileWrapper.style.display = '';
          if (submitFileInput) submitFileInput.required = true;
        });
        if (cancelSubmitBtn) cancelSubmitBtn.addEventListener('click', () => {
          submitModal.classList.add('hidden');
          submitMode = 'submit';
          if (submitFileWrapper) submitFileWrapper.style.display = '';
          if (submitFileInput) submitFileInput.required = true;
        });

        // Pending modal controls (OK and close)
        const pendingModal = document.getElementById('pending-modal');
        const pendingOkBtn = document.getElementById('pending-ok');
        const closePendingBtn = document.getElementById('close-pending-modal');
        if (pendingOkBtn) pendingOkBtn.addEventListener('click', () => pendingModal && pendingModal.classList.add('hidden'));
        if (closePendingBtn) closePendingBtn.addEventListener('click', () => pendingModal && pendingModal.classList.add('hidden'));
        if (pendingModal) {
          pendingModal.addEventListener('click', (e) => {
            if (e.target === pendingModal) pendingModal.classList.add('hidden');
          });
        }

        // Handle submit form upload
        if (submitForm) {
          submitForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = submitTaskIdInput.value;
            const note = (submitNoteInput.value || '').trim();
            const file = submitFileInput.files && submitFileInput.files[0];
            const submitModeInput = document.getElementById('submit-mode-input');
            const mode = submitModeInput ? (submitModeInput.value || 'submit') : 'submit';
            if (!note) { showToast('Description is required'); return; }
            // In 'submit' mode, file is required. In 'append' mode, file is optional.
            if (mode === 'submit' && !file) { showToast('File is required'); return; }
            const fd = new FormData();
            fd.append('id', id);
            fd.append('note', note);
            if (file) fd.append('file', file);
            // Put explicit mode from the form into FormData
            fd.append('mode', mode);
            // If this is an append, close the modal immediately for UX and perform the network call in background
            if (mode === 'append') {
              // close now
              if (submitModal) {
                submitModal.classList.add('hidden');
                submitModal.style.display = 'none';
              }
              if (submitForm) submitForm.reset();
              if (submitFileWrapper) submitFileWrapper.style.display = '';
              if (submitFileInput) submitFileInput.required = true;
              const submitModeInputEl = document.getElementById('submit-mode-input');
              if (submitModeInputEl) submitModeInputEl.value = 'submit';
            }

            fetch('../api/tasks_submit.php', { method: 'POST', body: fd, credentials: 'include' })
              .then(r => r.json())
              .then(data => {
                if (!data.success) throw new Error(data.error || 'Upload failed');
                // Update local task state depending on mode
                const idx = tasks.findIndex(t => t.id === parseInt(id));
                if (idx !== -1) {
                  if (mode === 'submit') {
                    // normal final submission: update local state
                    tasks[idx].status = 'completed';
                    tasks[idx].submissionFile = data.file || tasks[idx].submissionFile;
                    tasks[idx].submissionNote = note;
                  } else if (mode === 'append') {
                    // append: do NOT change task status or notes locally.
                    // The adjustment_note is visible only to the dept head; the task becomes pending only after dept head updates it.
                  }
                }
                renderTasks();
                // Reset form and UI (for submit mode this will also close modal)
                const finishedMode = mode;
                if (finishedMode === 'submit') {
                  if (submitForm) submitForm.reset();
                  if (submitFileWrapper) submitFileWrapper.style.display = '';
                  if (submitFileInput) submitFileInput.required = true;
                  if (submitModal) { submitModal.classList.add('hidden'); submitModal.style.display = 'none'; }
                }
                showToast(finishedMode === 'submit' ? 'Task submitted successfully' : 'Append request sent');
              })
              .catch(err => {
                showToast(err.message || 'Failed to submit task');
              });
          });
        }

        // Event listener for filter buttons (maps in-progress <-> in_progress)
        if (filterBtns) {
          // set default active
          if (filterBtns.length > 0) {
            filterBtns.forEach(b => b.classList.remove('active'));
            filterBtns[0].classList.add('active');
          }
          // current filter used by auto-refresh
          let __currentTaskFilter = 'all';
          filterBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const statusFilter = btn.dataset.status || 'all'; // use the button's dataset
              // toggle active class
              filterBtns.forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              __currentTaskFilter = statusFilter;
              fetchTasks(statusFilter);
            });
          });

          // Auto-refresh (1 second) while page visible
          const AUTO_REFRESH_MS = 1000; // 1s
          let __tasksAutoRefreshTimer = null;
          function startAutoRefresh() {
            if (__tasksAutoRefreshTimer) return;
            __tasksAutoRefreshTimer = setInterval(() => {
              if (!document.hidden) fetchTasks(__currentTaskFilter);
            }, AUTO_REFRESH_MS);
          }
          function stopAutoRefresh() {
            if (__tasksAutoRefreshTimer) {
              clearInterval(__tasksAutoRefreshTimer);
              __tasksAutoRefreshTimer = null;
            }
          }
          document.addEventListener('visibilitychange', () => {
            if (document.hidden) stopAutoRefresh(); else { fetchTasks(__currentTaskFilter); startAutoRefresh(); }
          });
          window.addEventListener('beforeunload', stopAutoRefresh);
          // Initial load and start auto-refresh
          fetchTasks('all').then(() => startAutoRefresh());
        }
      });
    </script>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Profile Modal logic
      const profileIcon = document.getElementById("profileIcon");
      const profileModal = document.getElementById("profileModal");
      const logoutBtn = document.getElementById("logoutBtn");
      const closeProfileModal = document.getElementById("closeProfileModal");
      profileIcon.addEventListener("click", () => {
        profileModal.classList.remove("hidden");
        profileModal.classList.add("flex");
      });
      closeProfileModal.addEventListener("click", () => {
        profileModal.classList.add("hidden");
        profileModal.classList.remove("flex");
      });
      logoutBtn.addEventListener("click", () => {
        window.location.href = "logout.php";
      });
      profileModal.addEventListener("click", (e) => {
        if (e.target === profileModal) {
          profileModal.classList.add("hidden");
          profileModal.classList.remove("flex");
        }
      });
    });
  </script>
</html>
