<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Attendance</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-100 p-6 lg:p-10">

    <header class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between z-10 sticky top-0">
        <div class="flex items-center space-x-4">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <img src="../assets/logo.png" alt="Logo" class="rounded-full">
            </div>
            <h1 id="header-title" class="text-xl font-bold text-gray-800">Dashboard</h1>
        </div>
        <div class="flex items-center space-x-4">
            <a href="dashboard.php" class="text-gray-600 hover:text-blue-600 transition-colors">
                <i class="fas fa-bell text-lg"></i>
            </a>
            <a href="dashboard.php" class="text-gray-600 hover:text-blue-600 transition-colors">
                <i class="fas fa-home text-lg"></i>
            </a>
            <img id="profileIcon" src="https://placehold.co/40x40/FF5733/FFFFFF?text=P" alt="Profile" class="w-10 h-10 rounded-full cursor-pointer">
            <!-- Profile Modal -->
            <div id="profileModal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs mx-4 flex flex-col items-center">
                    <img src="https://placehold.co/80x80/FFD700/000000?text=W+P" alt="Profile" class="w-20 h-20 rounded-full mb-4">
                    <button id="logoutBtn" class="w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 mb-2">Log out</button>
                    <button id="closeProfileModal" class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                </div>
            </div>
        </div>
    </header>

    <main class="mt-8 lg:mt-12">
        <div class="bg-white rounded-xl shadow-md p-6 lg:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Attendance Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-xl text-center shadow-sm">
                    <p class="text-sm text-blue-600 font-semibold">Total Days Present</p>
                    <p id="days-present" class="text-3xl font-bold text-blue-800 mt-2">0</p>
                </div>
                <div class="bg-green-50 p-6 rounded-xl text-center shadow-sm">
                    <p class="text-sm text-green-600 font-semibold">Total Days Absent</p>
                    <p id="days-absent" class="text-3xl font-bold text-green-800 mt-2">0</p>
                </div>
                <div class="bg-yellow-50 p-6 rounded-xl text-center shadow-sm">
                    <p class="text-sm text-yellow-600 font-semibold">Total Tardy</p>
                    <p id="total-tardy" class="text-3xl font-bold text-yellow-800 mt-2">0</p>
                </div>
                <div class="bg-red-50 p-6 rounded-xl text-center shadow-sm">
                    <p class="text-sm text-red-600 font-semibold">Total Undertime</p>
                    <p id="total-undertime" class="text-3xl font-bold text-red-800 mt-2">0</p>
                </div>
            </div>

            <div class="mb-8">
                <canvas id="attendanceChart"></canvas>
            </div>

            <div class="overflow-x-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Daily Records</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time In</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Out</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Daily records will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Biometric Modal -->
    <div id="biometric-modal" class="fixed inset-0 modal-bg flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm mx-auto text-center">
            <div id="biometric-icon" class="text-blue-600 text-6xl mb-4">
                <i class="fas fa-fingerprint animate-pulse"></i>
            </div>
            <h2 id="biometric-title" class="text-2xl font-bold text-gray-800 mb-2">Scan Your Fingerprint</h2>
            <p id="biometric-message" class="text-gray-600 mb-6">Please place your finger on the scanner to record your attendance.</p>
            <button id="close-biometric-modal" class="bg-gray-300 text-gray-800 font-semibold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300">Cancel</button>
            <div id="biometric-scan-result" class="mt-4 text-center hidden">
                <button id="record-attendance-btn" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-full hover:bg-blue-700 transition duration-300">Record Attendance</button>
            </div>
        </div>
    </div>
    
    <!-- Attendance Details Modal -->
    <div id="attendance-details-modal" class="fixed inset-0 modal-bg flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg mx-auto w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Attendance Details</h3>
                <button id="close-attendance-details-modal" class="text-gray-500 hover:text-gray-700 text-lg">&times;</button>
            </div>
            <div id="attendance-details-content" class="space-y-4">
                <!-- Details will be populated here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI & MODAL ELEMENTS ---
            const biometricBtn = document.getElementById('biometric-btn');
            const biometricModal = document.getElementById('biometric-modal');
            const closeBiometricModalBtn = document.getElementById('close-biometric-modal');
            const biometricIcon = document.getElementById('biometric-icon');
            const biometricTitle = document.getElementById('biometric-title');
            const biometricMessage = document.getElementById('biometric-message');
            const attendanceTableBody = document.getElementById('attendance-table-body');
            const attendanceDetailsModal = document.getElementById('attendance-details-modal');
            const closeAttendanceDetailsModalBtn = document.getElementById('close-attendance-details-modal');
            const recordAttendanceBtn = document.getElementById('record-attendance-btn');

            // --- DATA SIMULATION ---
            // Simulating attendance records
            let attendanceRecords = [
                { id: 1, date: "2023-11-20", timeIn: "08:50 AM", timeOut: "05:05 PM", status: "Present", tardy: false, undertime: false },
                { id: 2, date: "2023-11-21", timeIn: "09:15 AM", timeOut: "05:00 PM", status: "Present", tardy: true, undertime: false },
                { id: 3, date: "2023-11-22", timeIn: "08:55 AM", timeOut: "04:45 PM", status: "Present", tardy: false, undertime: true },
                { id: 4, date: "2023-11-23", timeIn: "09:00 AM", timeOut: "05:00 PM", status: "Present", tardy: false, undertime: false },
                { id: 5, date: "2023-11-24", timeIn: null, timeOut: null, status: "Absent", tardy: false, undertime: false }
            ];

            let myChart = null;

            // --- FUNCTIONALITY ---

            // Function to update the chart and summary cards
            function updateAttendanceSummary() {
                const daysPresent = attendanceRecords.filter(rec => rec.status === "Present").length;
                const daysAbsent = attendanceRecords.filter(rec => rec.status === "Absent").length;
                const totalTardy = attendanceRecords.filter(rec => rec.tardy).length;
                const totalUndertime = attendanceRecords.filter(rec => rec.undertime).length;

                document.getElementById('days-present').textContent = daysPresent;
                document.getElementById('days-absent').textContent = daysAbsent;
                document.getElementById('total-tardy').textContent = totalTardy;
                document.getElementById('total-undertime').textContent = totalUndertime;

                const ctx = document.getElementById('attendanceChart').getContext('2d');

                if (myChart) {
                    myChart.destroy();
                }

                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present', 'Absent'],
                        datasets: [{
                            data: [daysPresent, daysAbsent],
                            backgroundColor: ['#2563EB', '#D1D5DB'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Monthly Attendance Overview'
                            }
                        }
                    }
                });
            }

            // Function to render the daily attendance table
            function renderDailyRecords() {
                attendanceTableBody.innerHTML = ''; // Clear existing content
                attendanceRecords.forEach(rec => {
                    const statusColor = rec.status === "Present" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rec.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rec.timeIn || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rec.timeOut || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${rec.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${rec.id}" class="view-details-btn text-blue-600 hover:text-blue-900">View Details</button>
                        </td>
                    `;
                    attendanceTableBody.appendChild(row);
                });
            }

            // Function to show the attendance details modal
            function showAttendanceDetailsModal(record) {
                const content = document.getElementById('attendance-details-content');
                const tardyStatus = record.tardy ? '<span class="px-2 ml-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Tardy</span>' : '';
                const undertimeStatus = record.undertime ? '<span class="px-2 ml-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Undertime</span>' : '';
                
                content.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-700">Date:</span>
                        <span class="text-gray-600">${record.date}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Time In:</span>
                        <span class="text-gray-600">${record.timeIn || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Time Out:</span>
                        <span class="text-gray-600">${record.timeOut || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Status:</span>
                        <span class="text-gray-600">${record.status} ${tardyStatus} ${undertimeStatus}</span>
                    </div>
                `;
                attendanceDetailsModal.classList.remove('hidden');
            }
            
            // --- EVENT LISTENERS ---

            // Show biometric modal
            if (biometricBtn) {
                biometricBtn.addEventListener('click', () => {
                    biometricModal.classList.remove('hidden');
                    biometricIcon.innerHTML = '<i class="fas fa-fingerprint animate-pulse"></i>';
                    biometricTitle.textContent = 'Scan Your Fingerprint';
                    biometricMessage.textContent = 'Please place your finger on the scanner to record your attendance.';
                    document.getElementById('biometric-scan-result').classList.add('hidden');
                });
            }

            // Close biometric modal
            if (closeBiometricModalBtn) {
                closeBiometricModalBtn.addEventListener('click', () => {
                    biometricModal.classList.add('hidden');
                });
            }

            // Simulate biometric scan and show result
            if (biometricIcon) {
                biometricIcon.addEventListener('click', () => {
                    biometricIcon.innerHTML = '<i class="fas fa-check-circle text-green-600"></i>';
                    biometricTitle.textContent = 'Scan Successful!';
                    biometricMessage.textContent = 'Your identity has been verified. You can now record your attendance.';
                    document.getElementById('biometric-scan-result').classList.remove('hidden');
                });
            }
            
            // Record attendance after successful scan
            if (recordAttendanceBtn) {
                recordAttendanceBtn.addEventListener('click', () => {
                    const now = new Date();
                    const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    const date = now.toISOString().split('T')[0];

                    const lastRecord = attendanceRecords[attendanceRecords.length - 1];
                    const newRecord = {
                        id: attendanceRecords.length + 1,
                        date: date,
                        timeIn: null,
                        timeOut: null,
                        status: "Present",
                        tardy: false,
                        undertime: false
                    };
                    
                    if (lastRecord && lastRecord.date === date && lastRecord.timeIn && !lastRecord.timeOut) {
                        // User is checking out
                        lastRecord.timeOut = time;
                        biometricModal.classList.add('hidden');
                        alert("Checked out successfully!");
                    } else if (!lastRecord || lastRecord.date !== date || (lastRecord.date === date && lastRecord.timeIn && lastRecord.timeOut)) {
                        // User is checking in or starting a new day
                        newRecord.timeIn = time;
                        attendanceRecords.push(newRecord);
                        biometricModal.classList.add('hidden');
                        alert("Checked in successfully!");
                    }

                    updateAttendanceSummary();
                    renderDailyRecords();
                });
            }

            // Event listener for "View Details" buttons
            if (attendanceTableBody) {
                attendanceTableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-details-btn')) {
                        const recordId = parseInt(e.target.dataset.id);
                        const record = attendanceRecords.find(rec => rec.id === recordId);
                        if (record) {
                            showAttendanceDetailsModal(record);
                        }
                    }
                });
            }

            // Event listener to close the Attendance Details modal
            if (closeAttendanceDetailsModalBtn) {
                closeAttendanceDetailsModalBtn.addEventListener('click', () => {
                    attendanceDetailsModal.classList.add('hidden');
                });
            }

            // Initial calls to populate data
            updateAttendanceSummary();
            renderDailyRecords();
        });
    </script>
</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Profile Modal logic
        const profileIcon = document.getElementById('profileIcon');
        const profileModal = document.getElementById('profileModal');
        const logoutBtn = document.getElementById('logoutBtn');
        const closeProfileModal = document.getElementById('closeProfileModal');
        profileIcon.addEventListener('click', () => {
            profileModal.classList.remove('hidden');
            profileModal.classList.add('flex');
        });
        closeProfileModal.addEventListener('click', () => {
            profileModal.classList.add('hidden');
            profileModal.classList.remove('flex');
        });
        logoutBtn.addEventListener('click', () => {
            window.location.href = 'logout.php';
        });
        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.classList.add('hidden');
                profileModal.classList.remove('flex');
            }
        });
    });
</script>
