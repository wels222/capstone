<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>QR Attendance Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow: hidden;
        }
        .container { 
            display: flex; 
            gap: 15px; 
            max-width: 100%;
            width: 100%;
            height: calc(100vh - 20px);
            margin: 0 auto;
        }
        .left { 
            flex: 2; 
            background: #fff; 
            border-radius: 16px; 
            padding: 20px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .right { 
            flex: 1; 
            background: #fff; 
            border-radius: 16px; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow-y: auto;
            max-height: calc(100vh - 20px);
        }
        h2 { 
            color: #1f2937; 
            margin-bottom: 12px; 
            font-size: 22px;
            flex-shrink: 0;
        }
        #qr-reader {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            min-height: 300px;
            max-height: calc(100vh - 200px);
        }
        #qr-reader video {
            transform: scaleX(-1) !important;
            -webkit-transform: scaleX(-1) !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }
        #qr-reader__scan_region {
            border: 3px solid #10b981 !important;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5) !important;
        }
        #qr-reader__dashboard_section {
            padding: 10px !important;
        }
        .clock { 
            font-size: 26px; 
            font-weight: 700; 
            color: #1e40af; 
            margin-bottom: 16px;
            text-align: center;
            flex-shrink: 0;
        }
        .info-card { 
            width: 100%; 
            text-align: center; 
            padding: 20px; 
            border-radius: 12px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .info-pic { 
            width: 100px; 
            height: 100px; 
            border-radius: 50%; 
            object-fit: cover; 
            margin: 0 auto 12px;
            border: 3px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .name { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
        .emp-id { font-size: 14px; opacity: 0.9; margin-bottom: 4px; }
        .dept { font-size: 13px; opacity: 0.8; margin-bottom: 12px; }
        .time { 
            font-size: 18px; 
            font-weight: 600; 
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .status { 
            font-size: 16px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 8px;
            background: rgba(255,255,255,0.3);
        }
        .idle { 
            color: #6b7280; 
            text-align: center;
            margin-top: 30px;
            font-size: 15px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }
        .header-logo img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }
        .header-logo .logo-text {
            display: flex;
            flex-direction: column;
        }
        .header-logo .logo-text .main-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            line-height: 1;
        }
        .header-logo .logo-text .sub-title {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 12px auto 0;
            display: block;
            flex-shrink: 0;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { 
                flex-direction: column; 
                height: auto; 
                gap: 10px;
            }
            .left, .right {
                padding: 15px;
            }
            h2 { font-size: 18px; }
        }
    </style>
</head>
<body>
    <div class="container">
            <div class="left">
                <!-- Header with Mabini Logo -->
                <div class="header-logo">
                    <img src="../assets/logo.png" alt="Mabini Logo">
                    <div class="logo-text">
                        <div class="main-title">Mabini Municipal Office</div>
                        <div class="sub-title">QR Attendance System</div>
                    </div>
                </div>
                
                <h2><span class="status-indicator"></span>QR Attendance</h2>
                <div class="qr-panel" aria-live="polite">
                    <div class="qr-card" style="display:flex;flex-direction:column;align-items:center;gap:12px;">
                        <div class="qr-wrap" style="background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15);">
                            <img id="rotating-qr-img" src="" alt="Rotating QR code for attendance" class="qr-large" style="width:320px;height:320px;display:block;object-fit:contain;border-radius:6px;"/>
                        </div>

                        <!-- URL display that updates with the QR -->
                        <div style="width:100%;max-width:520px;display:flex;gap:8px;align-items:center;">
                            <a id="rotating-qr-link" href="#" target="_blank" rel="noopener noreferrer" class="link-url" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:10px 12px;background:rgba(255,255,255,0.8);border-radius:8px;color:#374151;text-decoration:none;border:1px solid rgba(15,23,42,0.04);">Open attendance link</a>
                            <button id="copyLinkBtn" class="btn small" style="padding:8px 12px;font-size:13px;">Copy</button>
                        </div>

                        <div id="qr-meta" class="qr-meta" style="font-size:13px;color:rgba(255,255,255,0.9);width:100%;max-width:520px;text-align:center;">
                            <div style="color:#f3f4f6;opacity:0.95">Next rotation in <strong id="rot-count">60</strong>s</div>
                            <div id="qr-updated" style="opacity:0.85;font-size:13px;margin-top:6px;color:#e6e7ee;">Last updated: —</div>
                        </div>
                    </div>
                </div>
                <!-- hint removed per request; kept minimal instruction in the How it works card -->
            </div>
            <div class="right">
                <div class="clock" id="clock"></div>
                <div class="info-card" id="info-display" style="margin-top:20px;text-align:center;display:none;position:relative;">
                    <img id="info-pic" class="info-pic" src="../assets/logo.png" alt="Employee Photo">
                    <div class="name" id="info-name">—</div>
                    <div class="emp-id" id="info-empid">Employee ID: —</div>
                    <div class="dept" id="info-dept">—</div>
                    <div class="time" id="info-time" style="display:flex;align-items:center;justify-content:center;gap:8px;">
                        <i class="fas fa-clock" style="color:rgba(255,255,255,0.9);"></i>
                        <span id="info-time-value">—</span>
                    </div>
                    <div class="status" id="info-status" style="display:inline-block;padding:8px 20px;border-radius:20px;font-size:15px;font-weight:700;margin-top:8px;">—</div>
                </div>
                <div class="idle" id="idle-message">Waiting for attendance scan...</div>
            </div>
        <script>
            // Clock
            function updateClock(){
            const d = new Date();
            const opts = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            };
            const time = d.toLocaleTimeString('en-US', opts);
            const date = d.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('clock').innerHTML = time + '<br><span style="font-size:14px;font-weight:400;color:#6b7280">' + date + '</span>';
        }
        setInterval(updateClock, 1000); 
        updateClock();

        // Rotating QR logic: fetch a signed QR link and build an image URL from external QR API
        let rotInterval = null;
        let countdownInterval = null;
        let serverTimeOffset = 0; // Track difference between server and client time

        async function fetchRotatingQR() {
            try {
                const res = await fetch('generate_qr.php');
                const data = await res.json();
                const url = data.url;
                
                // Sync with server time for accurate rotation on hosting
                if (data.serverTime) {
                    const clientTime = Math.floor(Date.now() / 1000);
                    serverTimeOffset = data.serverTime - clientTime;
                }
                
                const qrApi = 'https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=' + encodeURIComponent(url);
                const img = document.getElementById('rotating-qr-img');
                const link = document.getElementById('rotating-qr-link');
                const download = document.getElementById('downloadQrBtn');
                img.src = qrApi;
                link.href = url;
                link.textContent = url;
                download.href = qrApi; // let user download the image
                document.getElementById('qr-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
            } catch (err) {
                console.error('Failed to load rotating QR', err);
            }
        }

        function startRotation() {
            // initial fetch aligned to minute boundary
            fetchRotatingQR();
            // set countdown to seconds until next change
            function schedule() {
                // Use server-synced time for accurate rotation on hosting
                const now = Date.now() + (serverTimeOffset * 1000);
                const msToNextMinute = 60000 - (now % 60000);
                // update countdown every second
                let secondsLeft = Math.ceil(msToNextMinute / 1000);
                const counterEl = document.getElementById('rot-count');
                if (countdownInterval) clearInterval(countdownInterval);
                counterEl.textContent = secondsLeft;
                countdownInterval = setInterval(() => {
                    secondsLeft--;
                    if (secondsLeft < 0) secondsLeft = 0;
                    counterEl.textContent = secondsLeft;
                }, 1000);

                // schedule the next fetch exactly at next minute
                setTimeout(() => {
                    fetchRotatingQR();
                    // after first aligned update, set fixed interval every 60s
                    if (rotInterval) clearInterval(rotInterval);
                    rotInterval = setInterval(fetchRotatingQR, 60000);
                    schedule(); // reschedule countdown
                }, msToNextMinute + 200);
            }
            schedule();
        }

        document.getElementById('copyLinkBtn').addEventListener('click', async () => {
            const link = document.getElementById('rotating-qr-link').href;
            try {
                await navigator.clipboard.writeText(link);
                // show non-blocking notification (optional: you can remove this if not needed)
                alert('Link copied to clipboard');
            } catch (e) {
                prompt('Copy this link', link);
            }
        });

        // Poll for last scan produced by server-side attendance recorder
        async function pollLastScan() {
            try {
                const r = await fetch('last_scan.php', { cache: 'no-store' });
                if (!r.ok) return;
                const js = await r.json();
                if (js && js.success && js.scan) {
                    const s = js.scan;
                    const name = s.name || (s.employee_id ? s.employee_id : 'Employee');
                    // Determine action label
                    let actionLabel = '';
                    if (s.action === 'time_in') actionLabel = 'Time In';
                    else if (s.action === 'time_out') actionLabel = 'Time Out';
                    else if (s.action === 'already_timedout') actionLabel = 'Time Out (Already Recorded)';
                    else actionLabel = 'Attendance';
                    const status = s.status || s.time_in_status || '';
                    const time = s.time || '';
                    const employeeId = s.employee_id || '—';
                    const profilePicture = s.profile_picture || '';
                    showEmployeeInfo({ 
                        name: name, 
                        action: actionLabel, 
                        status: status, 
                        time: time, 
                        employeeId: employeeId,
                        photo: profilePicture
                    });
                }
            } catch (e) {
                // ignore
            }
        }

        function showEmployeeInfo(data) {
            const infoDisplay = document.getElementById('info-display');
            const idleMsg = document.getElementById('idle-message');
            const pic = document.getElementById('info-pic');
            const nameEl = document.getElementById('info-name');
            const empIdEl = document.getElementById('info-empid');
            const deptEl = document.getElementById('info-dept');
            const timeEl = document.getElementById('info-time-value');
            const statusEl = document.getElementById('info-status');

            // Fill data
            nameEl.textContent = data.name || '—';
            empIdEl.textContent = 'Employee ID: ' + (data.employeeId || '—');
            deptEl.textContent = data.action || 'Attendance';
            
            // Profile picture: use Mabini logo as default
            if (data.photo) {
                pic.src = data.photo;
            } else {
                pic.src = '../assets/logo.png';
            }
            
            if (data.time) {
                const t = new Date(data.time.replace(' ', 'T'));
                timeEl.textContent = t.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } else {
                timeEl.textContent = '—';
            }
            
            // Color-coded status badges (matching attendance dashboard exactly)
            const status = data.status || '—';
            statusEl.textContent = status;
            
            // Remove all status classes first
            statusEl.className = 'status';
            
            // Apply color and icon based on status (matching attendance/dashboard.php exactly)
            const s = status.toLowerCase();
            if (s.includes('present')) {
                statusEl.style.background = '#10b981';
                statusEl.style.color = '#fff';
                statusEl.innerHTML = '<i class="fas fa-check-circle" style="margin-right:6px;"></i>' + status;
            } else if (s.includes('late')) {
                statusEl.style.background = '#f59e0b';
                statusEl.style.color = '#fff';
                statusEl.innerHTML = '<i class="fas fa-clock" style="margin-right:6px;"></i>' + status;
            } else if (s.includes('absent')) {
                statusEl.style.background = '#ef4444';
                statusEl.style.color = '#fff';
                statusEl.innerHTML = '<i class="fas fa-times-circle" style="margin-right:6px;"></i>' + status;
            } else if (s.includes('on-time') || s.includes('ontime') || s === 'out' || s.includes(' out')) {
                statusEl.style.background = '#14b8a6';
                statusEl.style.color = '#fff';
                statusEl.innerHTML = '<i class="fas fa-user-check" style="margin-right:6px;"></i>' + status;
            } else if (s.includes('undertime')) {
                statusEl.style.background = '#fb923c';
                statusEl.style.color = '#fff';
                statusEl.innerHTML = '<i class="fas fa-hourglass-half" style="margin-right:6px;"></i>' + status;
            } else if (s.includes('overtime')) {
                statusEl.style.background = '#3b82f6';
                statusEl.style.color = '#fff';
                statusEl.innerHTML = '<i class="fas fa-clock" style="margin-right:6px;"></i>' + status;
            } else {
                statusEl.style.background = 'rgba(255,255,255,0.3)';
                statusEl.style.color = '#fff';
                statusEl.textContent = status;
            }

            // Show info card with animation and hide idle message
            idleMsg.style.display = 'none';
            infoDisplay.style.display = 'block';
            infoDisplay.style.opacity = '0';
            infoDisplay.style.transform = 'scale(0.95)';
            infoDisplay.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            
            requestAnimationFrame(() => {
                infoDisplay.style.opacity = '1';
                infoDisplay.style.transform = 'scale(1)';
            });

            // Auto-hide after 3 seconds and show idle message
            setTimeout(() => {
                infoDisplay.style.opacity = '0';
                infoDisplay.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    infoDisplay.style.display = 'none';
                    idleMsg.style.display = 'block';
                    // Reset to default logo
                    pic.src = '../assets/logo.png';
                }, 300);
            }, 3000);
        }

    // start polling every 2 seconds and run immediately once
    pollLastScan();
    setInterval(pollLastScan, 2000);

        // Start rotation
        startRotation();
    </script>
</body>
</html>
