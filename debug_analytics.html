<!DOCTYPE html>
<html>
  <head>
    <title>Analytics Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
        background: #f5f5f5;
      }
      .section {
        background: white;
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
      }
      .chart-container {
        width: 400px;
        height: 300px;
        margin: 20px auto;
      }
      .success {
        color: green;
        font-weight: bold;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      pre {
        background: #f4f4f4;
        padding: 10px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <h1>Leave Analytics Debug Tool</h1>

    <div class="section">
      <h2>1. API Connection Test</h2>
      <div id="api-status">Testing...</div>
    </div>

    <div class="section">
      <h2>2. Data Summary</h2>
      <div id="data-summary">Loading...</div>
    </div>

    <div class="section">
      <h2>3. Sample Chart (Status Distribution)</h2>
      <div class="chart-container">
        <canvas id="test-chart"></canvas>
      </div>
    </div>

    <div class="section">
      <h2>4. Raw API Response</h2>
      <pre id="raw-data">Loading...</pre>
    </div>

    <script>
      let analyticsData = null;
      let testChart = null;

      async function runTests() {
        const apiStatus = document.getElementById("api-status");
        const dataSummary = document.getElementById("data-summary");
        const rawData = document.getElementById("raw-data");

        try {
          // Test API
          apiStatus.innerHTML = "Fetching from API...";
          const month = new Date().getMonth() + 1;
          const year = new Date().getFullYear();
          const url = `api/leave_analytics.php?month=${month}&year=${year}`;

          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const json = await response.json();
          analyticsData = json.analytics;

          // Show status
          if (json.success) {
            apiStatus.innerHTML =
              '<span class="success">✓ API Connected Successfully</span>';
          } else {
            apiStatus.innerHTML = '<span class="error">✗ API Error</span>';
          }

          // Show summary
          dataSummary.innerHTML = `
                    <strong>Month:</strong> ${analyticsData.month}/${analyticsData.year}<br>
                    <strong>Total Requests:</strong> ${analyticsData.total_requests}<br>
                    <strong>Approved:</strong> ${analyticsData.by_status.approved}<br>
                    <strong>Pending:</strong> ${analyticsData.by_status.pending}<br>
                    <strong>Declined:</strong> ${analyticsData.by_status.declined}<br>
                    <strong>Decision Support Alerts:</strong> ${analyticsData.decision_support.length}<br>
                    <strong>Approval Rate:</strong> ${analyticsData.approval_rate}%
                `;

          // Show raw data
          rawData.textContent = JSON.stringify(json, null, 2);

          // Create chart
          createTestChart();
        } catch (error) {
          apiStatus.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
          dataSummary.innerHTML = `<span class="error">Failed to load data</span>`;
          rawData.textContent = error.stack;
        }
      }

      function createTestChart() {
        if (!analyticsData) return;

        const ctx = document.getElementById("test-chart");
        const data = {
          labels: ["Approved", "Pending", "Declined"],
          datasets: [
            {
              data: [
                analyticsData.by_status.approved,
                analyticsData.by_status.pending,
                analyticsData.by_status.declined,
              ],
              backgroundColor: ["#10b981", "#fbbf24", "#f43f5e"],
            },
          ],
        };

        testChart = new Chart(ctx, {
          type: "doughnut",
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
            },
          },
        });
      }

      // Run tests on load
      runTests();
    </script>
  </body>
</html>
